	processor pic18f248
	radix dec
	org 0x2000
	goto init_runtime

;---------------------------------------------------------
; Section: constants
;---------------------------------------------------------

; TBLPTRU: defined at lib/sfrnames.fs:13
TBLPTRU equ 0xff8

; TBLPTRH: defined at lib/sfrnames.fs:14
TBLPTRH equ 0xff7

; TBLPTRL: defined at lib/sfrnames.fs:15
TBLPTRL equ 0xff6

; TABLAT: defined at lib/sfrnames.fs:16
TABLAT equ 0xff5

; INDF0: defined at lib/sfrnames.fs:23
INDF0 equ 0xfef

; POSTINC0: defined at lib/sfrnames.fs:24
POSTINC0 equ 0xfee

; POSTDEC0: defined at lib/sfrnames.fs:25
POSTDEC0 equ 0xfed

; PREINC0: defined at lib/sfrnames.fs:26
PREINC0 equ 0xfec

; PLUSW0: defined at lib/sfrnames.fs:27
PLUSW0 equ 0xfeb

; FSR0H: defined at lib/sfrnames.fs:28
FSR0H equ 0xfea

; FSR0L: defined at lib/sfrnames.fs:29
FSR0L equ 0xfe9

; INDF1: defined at lib/sfrnames.fs:31
INDF1 equ 0xfe7

; FSR1H: defined at lib/sfrnames.fs:36
FSR1H equ 0xfe2

; FSR1L: defined at lib/sfrnames.fs:37
FSR1L equ 0xfe1

; POSTINC2: defined at lib/sfrnames.fs:40
POSTINC2 equ 0xfde

; POSTDEC2: defined at lib/sfrnames.fs:41
POSTDEC2 equ 0xfdd

; PREINC2: defined at lib/sfrnames.fs:42
PREINC2 equ 0xfdc

; FSR2H: defined at lib/sfrnames.fs:44
FSR2H equ 0xfda

; FSR2L: defined at lib/sfrnames.fs:45
FSR2L equ 0xfd9

; STATUS: defined at lib/sfrnames.fs:46
STATUS equ 0xfd8

; SSPBUF: defined at lib/sfrnames.fs:61
SSPBUF equ 0xfc9

; SSPSTAT: defined at lib/sfrnames.fs:63
SSPSTAT equ 0xfc7

; SSPCON1: defined at lib/sfrnames.fs:64
SSPCON1 equ 0xfc6

; EEADR: defined at lib/sfrnames.fs:89
EEADR equ 0xfa9

; EEDATA: defined at lib/sfrnames.fs:90
EEDATA equ 0xfa8

; EECON2: defined at lib/sfrnames.fs:91
EECON2 equ 0xfa7

; EECON1: defined at lib/sfrnames.fs:92
EECON1 equ 0xfa6

; PIR2: defined at lib/sfrnames.fs:97
PIR2 equ 0xfa1

; PIR1: defined at lib/sfrnames.fs:100
PIR1 equ 0xf9e

; TRISC: defined at lib/sfrnames.fs:104
TRISC equ 0xf94

; TRISA: defined at lib/sfrnames.fs:106
TRISA equ 0xf92

; PORTA: defined at lib/sfrnames.fs:116
PORTA equ 0xf80

; write-command: defined at tests/spi-pic.fs:19
write_MI_command equ 0x0

; read-command: defined at tests/spi-pic.fs:20
read_MI_command equ 0x1

; bit-change-command: defined at tests/spi-pic.fs:21
bit_MI_change_MI_command equ 0x2

;---------------------------------------------------------
; Section: code
;---------------------------------------------------------

; init_runtime: defined at lib/primitives.fs:3
init_runtime
	movlb 1
	clrf current_MI_command,1
	clrf current_MI_mode,1
	clrf current_MI_address,1
	clrf (current_MI_address+1),1
	movlw 0x5f
	movwf FSR0L,0
	clrf FSR0H,0
	movlw 0xbf
	movwf FSR2L,0
	clrf FSR2H,0

; main: defined at tests/spi-pic.fs:87
main
	call init_MI_spi

; mainloop: defined at tests/spi-pic.fs:84
mainloop
	call handle_MI_command
	bra mainloop

; op_zeroeq_z: defined at lib/primitives.fs:61
op_zeroeq_z
	movlw -1
	btfss STATUS,2,0
	addlw 1
	movwf PREINC0,0
	movwf PREINC0,0
	return

; table-addr!: defined at lib/tables.fs:1
table_MI_addr_EX_
	clrf TBLPTRU,0
	call _1_GT_2
	movf POSTDEC0,0,0
	movff POSTDEC0,TBLPTRH
	movf POSTDEC0,0,0
	movff POSTDEC0,TBLPTRL
	bcf EECON1,6,0
	return

; op_zeroeq: defined at lib/primitives.fs:70
op_zeroeq
	movf POSTDEC0,0,0
	iorwf POSTDEC0,0,0
	goto op_zeroeq_z

; flash-addr!: defined at lib/tables.fs:3
flash_MI_addr_EX_
	bcf INDF0,7,0
	bsf EECON1,7,0
	bra table_MI_addr_EX_

; dup: defined at lib/primitives.fs:29
dup
	movlw -1
	movff PLUSW0,PREINC0
	movff PLUSW0,PREINC0
	return

; op_cstore: defined at lib/primitives.fs:171
op_cstore
	btfsc INDF0,4,0
	goto eepromc_EX_
	movff POSTDEC0,FSR1H
	movff POSTDEC0,FSR1L
	movf POSTDEC0,0,0
	movff POSTDEC0,INDF1
	return

; op_cfetch_tos: defined at lib/primitives.fs:197
op_cfetch_tos
	btfsc INDF0,7,0
	goto flashc_AT_
	btfsc INDF0,4,0
	goto eepromc_AT_
	movff POSTDEC0,FSR1H
	movff POSTDEC0,FSR1L
	movff INDF1,PREINC0
	clrf PREINC0,0
	return

; 2drop: defined at lib/primitives.fs:243
_2drop
	movf POSTDEC0,1,0
	movf POSTDEC0,1,0
	movf POSTDEC0,1,0
	movf POSTDEC0,1,0
	return

; and: defined at lib/arithmetic.fs:63
and
	movff POSTDEC0,temp_x1
	movf POSTDEC0,0,0
	movf POSTDEC0,1,0
	andwf POSTINC0,1,0
	movf temp_x1,0,0
	andwf INDF0,1,0
	return

; or: defined at lib/arithmetic.fs:75
or
	movff POSTDEC0,temp_x1
	movf POSTDEC0,0,0
	movf POSTDEC0,1,0
	iorwf POSTINC0,1,0
	movf temp_x1,0,0
	iorwf INDF0,1,0
	return

; xor: defined at lib/arithmetic.fs:87
xor
	movff POSTDEC0,temp_x1
	movf POSTDEC0,0,0
	movf POSTDEC0,1,0
	xorwf POSTINC0,1,0
	movf temp_x1,0,0
	xorwf INDF0,1,0
	return

; 1>2: defined at lib/arithmetic.fs:106
_1_GT_2
	movf INDF0,0,0
	clrf INDF0,0
	movwf PREINC0,0
	clrf PREINC0,0
	return

; flashc@: defined at lib/tables.fs:14
flashc_AT_
	call flash_MI_addr_EX_
	tblrd*+
	movff TABLAT,PREINC0
	clrf PREINC0,0
	return

; eeprom-addr!: defined at lib/tables.fs:17
eeprom_MI_addr_EX_
	movwf EEADR,0
	bcf EECON1,7,0
	bcf EECON1,6,0
	return

; eepromc@: defined at lib/tables.fs:19
eepromc_AT_
	call eeprom_MI_addr_EX_
	bsf EECON1,0,0
	movf EEDATA,0,0
	return

; eepromc!: defined at lib/tables.fs:23
eepromc_EX_
	call eeprom_MI_addr_EX_
	movf POSTDEC0,0,0
	movff POSTDEC0,EEDATA
	bsf EECON1,2,0
	movlw 0x55
	movwf EECON2,0
	movlw 0xaa
	movwf EECON2,0
	bsf EECON1,1,0
_lbl___77
	btfsc EECON1,1,0
	bra _lbl___77
	bcf EECON1,2,0
	bcf PIR2,4,0
	return

; init-spi: defined at tests/spi-pic.fs:28
init_MI_spi
	bcf TRISC,5,0
	bsf TRISC,3,0
	bsf TRISA,5,0
	movlw 0x40
	movwf SSPSTAT,0
	movlw 0x24
	movwf SSPCON1,0
	return

; receive-byte: defined at tests/spi-pic.fs:36
receive_MI_byte
	btfss PIR1,3,0
	bra receive_MI_byte
	movff SSPBUF,PREINC0
	clrf PREINC0,0
	return

; send-bytes: defined at tests/spi-pic.fs:39
send_MI_bytes
	movff current_MI_address,PREINC0
	movff (current_MI_address+1),PREINC0
_lbl___191
	call dup
	call op_cfetch_tos
_lbl___192
	btfsc PORTA,5,0
	goto _2drop
	btfsc PIR1,3,0
	bra _lbl___192
	movf POSTDEC0,0,0
	movff POSTDEC0,SSPBUF
	movf POSTDEC0,0,0
	infsnz POSTINC0,1,0
	incf INDF0,1,0
	bra _lbl___191

; receive-bytes: defined at tests/spi-pic.fs:50
receive_MI_bytes
	movff current_MI_address,PREINC0
	movff (current_MI_address+1),PREINC0
_lbl___196
	movff POSTDEC0,PREINC2
	movff POSTDEC0,PREINC2
_lbl___197
	btfss PORTA,5,0
	bra _lbl___198
	movf POSTDEC2,1,0
	movf POSTDEC2,1,0
	return
_lbl___198
	btfss PIR1,3,0
	bra _lbl___197
	movff SSPBUF,PREINC0
	clrf PREINC0,0
	movff POSTDEC2,PREINC0
	movff POSTINC2,PREINC0
	call op_cstore
	movff POSTDEC2,PREINC0
	movff POSTDEC2,PREINC0
	movf POSTDEC0,0,0
	infsnz POSTINC0,1,0
	incf INDF0,1,0
	bra _lbl___196

; receive-masks-bytes: defined at tests/spi-pic.fs:61
receive_MI_masks_MI_bytes
	movff current_MI_address,PREINC0
	movff (current_MI_address+1),PREINC0
_lbl___201
	movff POSTDEC0,PREINC2
	movff POSTDEC0,PREINC2
_lbl___202
	btfss PORTA,5,0
	bra _lbl___203
	movf POSTDEC2,1,0
	movf POSTDEC2,1,0
	return
_lbl___203
	btfss PIR1,3,0
	bra _lbl___202
	movff SSPBUF,PREINC0
	clrf PREINC0,0
	comf POSTDEC0,1,0
	comf POSTINC0,1,0
	movff POSTDEC2,PREINC0
	movff POSTINC2,PREINC0
	call op_cfetch_tos
	call and
_lbl___205
	btfss PORTA,5,0
	bra _lbl___206
	movf POSTDEC2,1,0
	movf POSTDEC2,1,0
	movf POSTDEC0,1,0
	movf POSTDEC0,1,0
	return
_lbl___206
	btfss PIR1,3,0
	bra _lbl___205
	movff SSPBUF,PREINC0
	clrf PREINC0,0
	call or
	movff POSTDEC2,PREINC0
	movff POSTINC2,PREINC0
	call op_cstore
	movff POSTDEC2,PREINC0
	movff POSTDEC2,PREINC0
	movf POSTDEC0,0,0
	infsnz POSTINC0,1,0
	incf INDF0,1,0
	bra _lbl___201

; handle-command: defined at tests/spi-pic.fs:74
handle_MI_command
	call receive_MI_byte
	call receive_MI_byte
	movf POSTDEC0,0,0
	movff POSTDEC0,current_MI_address
	call receive_MI_byte
	movf POSTDEC0,0,0
	movff POSTDEC0,(1+current_MI_address)
	call dup
	movf POSTDEC0,0,0
	iorwf POSTDEC0,0,0
	bnz _lbl___209
	movf POSTDEC0,1,0
	movf POSTDEC0,1,0
	goto send_MI_bytes
_lbl___209
	call dup
	movlw read_MI_command
	movwf PREINC0,0
	clrf PREINC0,0
	call xor
	call op_zeroeq
	movf POSTDEC0,0,0
	iorwf POSTDEC0,0,0
	bz _lbl___211
	movf POSTDEC0,1,0
	movf POSTDEC0,1,0
	goto receive_MI_bytes
_lbl___211
	call dup
	movlw bit_MI_change_MI_command
	movwf PREINC0,0
	clrf PREINC0,0
	call xor
	call op_zeroeq
	movf POSTDEC0,0,0
	iorwf POSTDEC0,0,0
	bz _lbl___213
	movf POSTDEC0,1,0
	movf POSTDEC0,1,0
	call receive_MI_masks_MI_bytes
_lbl___213
	movf POSTDEC0,1,0
	movf POSTDEC0,1,0
	return

;---------------------------------------------------------
; Section: memory
;---------------------------------------------------------

; temp_x1: defined at lib/primitives.fs:22
temp_x1 equ 0x0

; current-command: defined at tests/spi-pic.fs:23
current_MI_command equ 0x100

; current-mode: defined at tests/spi-pic.fs:24
current_MI_mode equ 0x101

; current-address: defined at tests/spi-pic.fs:26
current_MI_address equ 0x102

END
