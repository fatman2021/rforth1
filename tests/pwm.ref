	processor pic18f248
	radix dec
	org 0x2000
	goto init_runtime

;---------------------------------------------------------
; Section: constants
;---------------------------------------------------------

TBLPTRU equ 0xff8

TBLPTRH equ 0xff7

TBLPTRL equ 0xff6

TABLAT equ 0xff5

INTCON equ 0xff2

INDF0 equ 0xfef

POSTINC0 equ 0xfee

POSTDEC0 equ 0xfed

PREINC0 equ 0xfec

PLUSW0 equ 0xfeb

FSR0H equ 0xfea

FSR0L equ 0xfe9

WREG equ 0xfe8

INDF1 equ 0xfe7

FSR1H equ 0xfe2

FSR1L equ 0xfe1

INDF2 equ 0xfdf

POSTDEC2 equ 0xfdd

PREINC2 equ 0xfdc

FSR2H equ 0xfda

FSR2L equ 0xfd9

STATUS equ 0xfd8

TMR0H equ 0xfd7

TMR0L equ 0xfd6

T0CON equ 0xfd5

TMR1H equ 0xfcf

TMR1L equ 0xfce

T1CON equ 0xfcd

ADCON1 equ 0xfc1

RCREG equ 0xfae

TXREG equ 0xfad

EEADR equ 0xfa9

EEDATA equ 0xfa8

EECON1 equ 0xfa6

PIR1 equ 0xf9e

TRISC equ 0xf94

TRISA equ 0xf92

LATC equ 0xf8b

LATA equ 0xf89

main_MI_time equ -28000

pulse_MI_max equ -6000

delta equ 10

;---------------------------------------------------------
; Section: code
;---------------------------------------------------------

_DT_
	call _1_GT_2
	call emit_MI_8

emit_MI_8
	call dup
	movf POSTDEC0,0,0
	swapf POSTINC0,1,0
	movf POSTDEC0,0
	movf POSTDEC0,0
	andlw 0xf
	call emit_MI_4
	movf POSTDEC0,0
	movf POSTDEC0,0
	andlw 0xf

emit_MI_4
	call nibble_MI_to_MI_hex

emit
	btfss PIR1,4,0
	bra emit
	movwf TXREG,0
	return

_GT__EQ_
	call _2dupxor_GT_w
	btfss WREG,7,0
	bra _lbl___25
	movf POSTDEC0,1,0
	movf POSTDEC0,1,0
	call _0_LT_
	goto op_zeroeq
_lbl___25
	call op_minus
	call _0_LT_

op_zeroeq
	movf POSTDEC0,0,0
	iorwf POSTDEC0,0,0

op_zeroeq_z
	movlw -1
	btfss STATUS,2,0
	addlw 1
	movwf PREINC0,0
	movwf PREINC0,0
	return

tmr1_MI_wait
	btfsc PIR1,0,0
	return
	bra tmr1_MI_wait

main
	call greetings
	call init_MI_pwm

main_MI_loop
	movlw LOW(-6000)
	movwf pulse0,1
	movlw HIGH(-6000)
	movwf (pulse0+1),1
	movlw LOW(-6000)
	movwf pulse1,1
	movlw HIGH(-6000)
	movwf (pulse1+1),1
_lbl___208
	call pwm
	call key
	movwf PREINC0,0
	clrf PREINC0,0
	call dup
	movlw 48
	movwf PREINC0,0
	clrf PREINC0,0
	call xor
	movf POSTDEC0,0,0
	iorwf POSTDEC0,0,0
	bnz _lbl___210
	call read16
	movff POSTDEC0,(pulse0+1)
	movff POSTDEC0,pulse0
	movlw LOW((_data___1+0x8000))
	movwf PREINC0,0
	movlw HIGH((_data___1+0x8000))
	movwf PREINC0,0
	movlw 1
	movwf PREINC0,0
	clrf PREINC0,0
	call type
_lbl___210
	call dup
	movlw 49
	movwf PREINC0,0
	clrf PREINC0,0
	call xor
	movf POSTDEC0,0,0
	iorwf POSTDEC0,0,0
	bnz _lbl___212
	call read16
	movff POSTDEC0,(pulse1+1)
	movff POSTDEC0,pulse1
	movlw LOW((_data___2+0x8000))
	movwf PREINC0,0
	movlw HIGH((_data___2+0x8000))
	movwf PREINC0,0
	movlw 1
	movwf PREINC0,0
	clrf PREINC0,0
	call type
_lbl___212
	call dup
	movlw 112
	movwf PREINC0,0
	clrf PREINC0,0
	call xor
	movf POSTDEC0,0,0
	iorwf POSTDEC0,0,0
	bnz _lbl___214
	movlw LOW((_data___3+0x8000))
	movwf PREINC0,0
	movlw HIGH((_data___3+0x8000))
	movwf PREINC0,0
	movlw 8
	movwf PREINC0,0
	clrf PREINC0,0
	call type
	movff pulse0,PREINC0
	movff (pulse0+1),PREINC0
	call _DT_
	call cr
	movlw LOW((_data___4+0x8000))
	movwf PREINC0,0
	movlw HIGH((_data___4+0x8000))
	movwf PREINC0,0
	movlw 8
	movwf PREINC0,0
	clrf PREINC0,0
	call type
	movff pulse1,PREINC0
	movff (pulse1+1),PREINC0
	call _DT_
	call cr
_lbl___214
	call dup
	movlw 43
	movwf PREINC0,0
	clrf PREINC0,0
	call xor
	movf POSTDEC0,0,0
	iorwf POSTDEC0,0,0
	bnz _lbl___216
	movff pulse1,PREINC0
	movff (pulse1+1),PREINC0
	movlw LOW(delta)
	movf POSTDEC0,1,0
	addwf POSTINC0,1,0
	movlw HIGH(delta)
	addwfc INDF0,1,0
	movff POSTDEC0,(pulse1+1)
	movff POSTDEC0,pulse1
	movlw LOW((_data___5+0x8000))
	movwf PREINC0,0
	movlw HIGH((_data___5+0x8000))
	movwf PREINC0,0
	movlw 1
	movwf PREINC0,0
	clrf PREINC0,0
	call type
	movff pulse1,PREINC0
	movff (pulse1+1),PREINC0
	call _DT_
	call cr
_lbl___216
	call dup
	movlw 45
	movwf PREINC0,0
	clrf PREINC0,0
	call xor
	movf POSTDEC0,0,0
	iorwf POSTDEC0,0,0
	bnz _lbl___218
	movff pulse1,PREINC0
	movff (pulse1+1),PREINC0
	movlw LOW((-delta))
	movf POSTDEC0,1,0
	addwf POSTINC0,1,0
	movlw HIGH((-delta))
	addwfc INDF0,1,0
	movff POSTDEC0,(pulse1+1)
	movff POSTDEC0,pulse1
	movlw LOW((_data___6+0x8000))
	movwf PREINC0,0
	movlw HIGH((_data___6+0x8000))
	movwf PREINC0,0
	movlw 1
	movwf PREINC0,0
	clrf PREINC0,0
	call type
	movff pulse1,PREINC0
	movff (pulse1+1),PREINC0
	call _DT_
	call cr
_lbl___218
	movf POSTDEC0,1,0
	movf POSTDEC0,1,0
	bra _lbl___208

read8
	call read4
	movf POSTDEC0,0,0
	swapf POSTINC0,1,0
	call read4

or
	movff POSTDEC0,temp_x1
	movf POSTDEC0,0,0
	movf POSTDEC0,1,0
	iorwf POSTINC0,1,0
	movf temp_x1,0,0
	iorwf INDF0,1,0
	return

table_MI_addr_EX_
	clrf TBLPTRU,0
	call _1_GT_2
	movf POSTDEC0,0,0
	movff POSTDEC0,TBLPTRH
	movf POSTDEC0,0,0
	movff POSTDEC0,TBLPTRL
	bcf EECON1,6,0
	return

greetings
	movlw LOW((_data___7+0x8000))
	movwf PREINC0,0
	movlw HIGH((_data___7+0x8000))
	movwf PREINC0,0
	movlw 18
	movwf PREINC0,0
	clrf PREINC0,0

type
	call dup
	movf POSTDEC0,0,0
	iorwf POSTDEC0,0,0
	btfsc STATUS,2,0
	goto _2drop
	movf POSTDEC0,0
	movf POSTDEC0,0
	movwf PREINC2,0
_lbl___88
	call dup
	call op_cfetch_tos
	movf POSTDEC0,0
	movf POSTDEC0,0
	call emit
	movf POSTDEC0,0,0
	infsnz POSTINC0,1,0
	incf INDF0,1,0
	decfsz INDF2,1,0
	bra _lbl___88
	movf POSTDEC2,1,0
	movf POSTDEC0,1,0
	movf POSTDEC0,1,0
	return

init_runtime
	movlb 1
	clrf pulse0,1
	clrf (pulse0+1),1
	clrf pulse1,1
	clrf (pulse1+1),1
	movlw 0x5f
	movwf FSR0L,0
	clrf FSR0H,0
	movlw 0xbf
	movwf FSR2L,0
	clrf FSR2H,0
	goto main

flash_MI_addr_EX_
	bcf INDF0,7,0
	bsf EECON1,7,0
	bra table_MI_addr_EX_

cr
	movlw 0xa
	call emit
	movlw 0xd
	goto emit

dup
	movlw -1
	movff PLUSW0,PREINC0
	movff PLUSW0,PREINC0
	return

op_cfetch_tos
	btfsc INDF0,7,0
	goto flashc_AT_
	btfsc INDF0,4,0
	goto eepromc_AT_
	movff POSTDEC0,FSR1H
	movff POSTDEC0,FSR1L
	movff INDF1,PREINC0
	clrf PREINC0,0
	return

swap
	movff POSTDEC0,(temp_x1+1)
	movff POSTDEC0,temp_x1
	movff POSTDEC0,PREINC2
	movff POSTDEC0,PREINC2
	movff temp_x1,PREINC0
	movff (temp_x1+1),PREINC0
	movff POSTDEC2,PREINC0
	movff POSTDEC2,PREINC0
	return

_2drop
	movf POSTDEC0,1,0
	movf POSTDEC0,1,0
	movf POSTDEC0,1,0
	movf POSTDEC0,1,0
	return

op_minus
	movff POSTDEC0,temp_x1
	movf POSTDEC0,0,0
	movf POSTDEC0,1,0
	subwf POSTINC0,1,0
	movf temp_x1,0,0
	subwfb INDF0,1,0
	return

xor
	movff POSTDEC0,temp_x1
	movf POSTDEC0,0,0
	movf POSTDEC0,1,0
	xorwf POSTINC0,1,0
	movf temp_x1,0,0
	xorwf INDF0,1,0
	return

_1_GT_2
	movf INDF0,0,0
	clrf INDF0,0
	movwf PREINC0,0
	clrf PREINC0,0
	return

_0_LT_
	movlw -1
	btfss POSTDEC0,7,0
	movlw 0
	movwf POSTINC0,0
	movwf INDF0,0
	return

_2dupxor_GT_w
	movf POSTDEC0,1,0
	movf POSTDEC0,1,0
	movf POSTINC0,0,0
	xorwf PREINC0,0,0
	return

flashc_AT_
	call flash_MI_addr_EX_
	tblrd*+
	movff TABLAT,PREINC0
	clrf PREINC0,0
	return

eeprom_MI_addr_EX_
	movwf EEADR,0
	bcf EECON1,7,0
	bcf EECON1,6,0
	return

eepromc_AT_
	call eeprom_MI_addr_EX_
	bsf EECON1,0,0
	movf EEDATA,0,0
	return

nibble_MI_to_MI_hex
	addlw 0xf6
	btfsc STATUS,0,0
	addlw 7
	addlw 0x3a
	return

read4
	call key
	movwf PREINC0,0
	clrf PREINC0,0
	call dup
	movlw 65
	movwf PREINC0,0
	clrf PREINC0,0
	call _GT__EQ_
	movf POSTDEC0,0,0
	iorwf POSTDEC0,0,0
	bz _lbl___95
	movf POSTDEC0,0
	movf POSTDEC0,0
	andlw 223
	movwf PREINC0,0
	clrf PREINC0,0
	movlw LOW((-55))
	movf POSTDEC0,1,0
	addwf POSTINC0,1,0
	movlw HIGH((-55))
	addwfc INDF0,1,0
	return
_lbl___95
	movlw LOW((-48))
	movf POSTDEC0,1,0
	addwf POSTINC0,1,0
	movlw HIGH((-48))
	addwfc INDF0,1,0
	return

read16
	call read8
	call read8
	call swap
	movf POSTDEC0,0,0
	movf POSTDEC0,0,0
	movwf INDF0,0
	return

key
	btfss PIR1,5,0
	bra key
	movf RCREG,0,0
	return

set_MI_tmr0_MI_wait
	call _1_GT_2
	movf POSTDEC0,0,0
	movff POSTDEC0,TMR0H
	movf POSTDEC0,0,0
	movff POSTDEC0,TMR0L
	bcf INTCON,2,0
_lbl___196
	btfsc INTCON,2,0
	return
	bra _lbl___196

set_MI_tmr1
	call _1_GT_2
	movf POSTDEC0,0,0
	movff POSTDEC0,TMR1H
	movf POSTDEC0,0,0
	movff POSTDEC0,TMR1L
	bcf PIR1,0,0
	return

pwm
	movlw LOW(pulse_MI_max)
	movwf PREINC0,0
	movlw HIGH(pulse_MI_max)
	movwf PREINC0,0
	call set_MI_tmr1
	bsf LATA,2,0
	movff pulse0,PREINC0
	movff (pulse0+1),PREINC0
	call set_MI_tmr0_MI_wait
	bcf LATA,2,0
	call tmr1_MI_wait
	movlw LOW(pulse_MI_max)
	movwf PREINC0,0
	movlw HIGH(pulse_MI_max)
	movwf PREINC0,0
	call set_MI_tmr1
	bsf LATC,1,0
	movff pulse1,PREINC0
	movff (pulse1+1),PREINC0
	call set_MI_tmr0_MI_wait
	bcf LATC,1,0
	call tmr1_MI_wait
	movlw LOW(main_MI_time)
	movwf PREINC0,0
	movlw HIGH(main_MI_time)
	movwf PREINC0,0
	call set_MI_tmr1
_lbl___204
	btfsc PIR1,5,0
	return
	btfsc PIR1,0,0
	bra pwm
	bra _lbl___204

init_MI_pwm
	movlw 7
	movwf ADCON1,0
	bcf TRISA,2,0
	bcf TRISC,1,0
	movlw 0x88
	movwf T0CON,0
	clrf TMR1H,0
	clrf TMR1L,0
	movlw 0x91
	movwf T1CON,0
	return

;---------------------------------------------------------
; Section: memory
;---------------------------------------------------------

temp_x1 equ 0x0

pulse0 equ 0x100

pulse1 equ 0x102

;---------------------------------------------------------
; Section: static data
;---------------------------------------------------------

_data___1
	db 48

_data___2
	db 49

_data___3
	db 80,87,77,32,48,32,58,32

_data___4
	db 80,87,77,32,49,32,58,32

_data___5
	db 43

_data___6
	db 45

_data___7
	db 13,10,80,87,77,32,71,101
	db 110,101,114,97,116,111,114,62
	db 13,10

END
