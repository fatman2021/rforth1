	processor pic18f248
	radix dec
	org 0x2000
	goto init_runtime

;---------------------------------------------------------
; Section: constants
;---------------------------------------------------------

TBLPTRU equ 0xff8

TBLPTRH equ 0xff7

TBLPTRL equ 0xff6

TABLAT equ 0xff5

INDF0 equ 0xfef

POSTINC0 equ 0xfee

POSTDEC0 equ 0xfed

PREINC0 equ 0xfec

PLUSW0 equ 0xfeb

FSR0H equ 0xfea

FSR0L equ 0xfe9

INDF1 equ 0xfe7

FSR1H equ 0xfe2

FSR1L equ 0xfe1

INDF2 equ 0xfdf

POSTDEC2 equ 0xfdd

PREINC2 equ 0xfdc

FSR2H equ 0xfda

FSR2L equ 0xfd9

STATUS equ 0xfd8

ADRESL equ 0xfc3

ADCON0 equ 0xfc2

ADCON1 equ 0xfc1

RCREG equ 0xfae

TXREG equ 0xfad

EEADR equ 0xfa9

EEDATA equ 0xfa8

EECON1 equ 0xfa6

PIR1 equ 0xf9e

;---------------------------------------------------------
; Section: code
;---------------------------------------------------------

disp0
	movlw LOW((_data___1+0x8000))
	movwf PREINC0,0
	movlw HIGH((_data___1+0x8000))
	movwf PREINC0,0
	movlw 10
	movwf PREINC0,0
	clrf PREINC0,0
	call type
	clrf PREINC0,0
	clrf PREINC0,0

an_DT_
	call an
	call _DT_

cr
	movlw 0xa
	call emit
	movlw 0xd
	goto emit

_DT_
	call _1_GT_2
	call emit_MI_8

emit_MI_8
	call dup
	movf POSTDEC0,0,0
	swapf POSTINC0,1,0
	movf POSTDEC0,0
	movf POSTDEC0,0
	andlw 0xf
	call emit_MI_4
	movf POSTDEC0,0
	movf POSTDEC0,0
	andlw 0xf

emit_MI_4
	call nibble_MI_to_MI_hex

emit
	btfss PIR1,4,0
	bra emit
	movwf TXREG,0
	return

_8_ST_
	call _2_ST_
	call _2_ST_

_2_ST_
	bcf STATUS,0,0
	movf POSTDEC0,0,0
	rlcf POSTINC0,1,0
	rlcf INDF0,1,0
	return

table_MI_addr_EX_
	clrf TBLPTRU,0
	call _1_GT_2
	movf POSTDEC0,0,0
	movff POSTDEC0,TBLPTRH
	movf POSTDEC0,0,0
	movff POSTDEC0,TBLPTRL
	bcf EECON1,6,0
	return

an
	call select_MI_channel

measure
	bsf ADCON0,2,0
_lbl___199
	btfsc ADCON0,2,0
	bra _lbl___199
	movff ADRESL,PREINC0
	movff (ADRESL+1),PREINC0
	return

init_runtime
	movlb 1
	movlw 0x5f
	movwf FSR0L,0
	clrf FSR0H,0
	movlw 0xbf
	movwf FSR2L,0
	clrf FSR2H,0

main
	movlw LOW((_data___4+0x8000))
	movwf PREINC0,0
	movlw HIGH((_data___4+0x8000))
	movwf PREINC0,0
	movlw 7
	movwf PREINC0,0
	clrf PREINC0,0
	call type
	call cr
	call init_MI_adc
_lbl___208
	call key
	movwf PREINC0,0
	clrf PREINC0,0
	movf POSTDEC0,1,0
	movf POSTDEC0,1,0
	call disp0
	call disp1
	call disp2
	bra _lbl___208

flash_MI_addr_EX_
	bcf INDF0,7,0
	bsf EECON1,7,0
	bra table_MI_addr_EX_

disp1
	movlw LOW((_data___2+0x8000))
	movwf PREINC0,0
	movlw HIGH((_data___2+0x8000))
	movwf PREINC0,0
	movlw 10
	movwf PREINC0,0
	clrf PREINC0,0
	call type
	movlw 1
	movwf PREINC0,0
	clrf PREINC0,0
	goto an_DT_

disp2
	movlw LOW((_data___3+0x8000))
	movwf PREINC0,0
	movlw HIGH((_data___3+0x8000))
	movwf PREINC0,0
	movlw 10
	movwf PREINC0,0
	clrf PREINC0,0
	call type
	movlw 2
	movwf PREINC0,0
	clrf PREINC0,0
	goto an_DT_

dup
	movlw -1
	movff PLUSW0,PREINC0
	movff PLUSW0,PREINC0
	return

op_cfetch_tos
	btfsc INDF0,7,0
	goto flashc_AT_
	btfsc INDF0,4,0
	goto eepromc_AT_
	movff POSTDEC0,FSR1H
	movff POSTDEC0,FSR1L
	movff INDF1,PREINC0
	clrf PREINC0,0
	return

_2drop
	movf POSTDEC0,1,0
	movf POSTDEC0,1,0
	movf POSTDEC0,1,0
	movf POSTDEC0,1,0
	return

or
	movff POSTDEC0,temp_x1
	movf POSTDEC0,0,0
	movf POSTDEC0,1,0
	iorwf POSTINC0,1,0
	movf temp_x1,0,0
	iorwf INDF0,1,0
	return

_1_GT_2
	movf INDF0,0,0
	clrf INDF0,0
	movwf PREINC0,0
	clrf PREINC0,0
	return

flashc_AT_
	call flash_MI_addr_EX_
	tblrd*+
	movff TABLAT,PREINC0
	clrf PREINC0,0
	return

eeprom_MI_addr_EX_
	movwf EEADR,0
	bcf EECON1,7,0
	bcf EECON1,6,0
	return

eepromc_AT_
	call eeprom_MI_addr_EX_
	bsf EECON1,0,0
	movf EEDATA,0,0
	return

nibble_MI_to_MI_hex
	addlw 0xf6
	btfsc STATUS,0,0
	addlw 7
	addlw 0x3a
	return

type
	call dup
	movf POSTDEC0,0,0
	iorwf POSTDEC0,0,0
	btfsc STATUS,2,0
	goto _2drop
	movf POSTDEC0,0
	movf POSTDEC0,0
	movwf PREINC2,0
_lbl___89
	call dup
	call op_cfetch_tos
	movf POSTDEC0,0
	movf POSTDEC0,0
	call emit
	movf POSTDEC0,0,0
	infsnz POSTINC0,1,0
	incf INDF0,1,0
	decfsz INDF2,1,0
	bra _lbl___89
	movf POSTDEC2,1,0
	movf POSTDEC0,1,0
	movf POSTDEC0,1,0
	return

key
	btfss PIR1,5,0
	bra key
	movf RCREG,0,0
	return

select_MI_channel
	call _8_ST_
	movf ADCON0,0,0
	andlw 0xc7
	movwf PREINC0,0
	clrf PREINC0,0
	call or
	movf POSTDEC0,0,0
	movff POSTDEC0,ADCON0
	return

init_MI_adc
	movlw 0x81
	movwf ADCON0,0
	movlw 0xc2
	movwf ADCON1,0
	return

;---------------------------------------------------------
; Section: memory
;---------------------------------------------------------

temp_x1 equ 0x0

;---------------------------------------------------------
; Section: static data
;---------------------------------------------------------

; defined at tests/colortest.fs:9 as:
; Sensor 0: 
_data___1
	db 83,101,110,115,111,114,32,48
	db 58,32

; defined at tests/colortest.fs:10 as:
; Sensor 1: 
_data___2
	db 83,101,110,115,111,114,32,49
	db 58,32

; defined at tests/colortest.fs:11 as:
; Sensor 2: 
_data___3
	db 83,101,110,115,111,114,32,50
	db 58,32

; defined at tests/colortest.fs:14 as:
; Welcome
_data___4
	db 87,101,108,99,111,109,101

END
